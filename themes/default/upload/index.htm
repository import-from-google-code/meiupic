{template block/header}

<div id="bodywrap">
    <table class="layout">
        <tr>
            <td class="left">
                <div class="mainbody">
                    <div class="col titbg">
                        <h1 class="f_left">上传照片</h1>
                        <h4 class="f_left"></h4>
                        <div class="rmenu f_right">
                           切换上传方式: <a href="{link ctl=upload act=index}" class="current">高级上传</a> | <a href="{link ctl=upload act=normal}">普通上传</a>
                        </div>
                    </div>
                    <div class="innercol grid">
<!--{if count($albums_list) > 0}-->
<link rel="stylesheet" href="{$statics_path}plupload/plupload.queue.css" type="text/css" />
<script type="text/javascript" src="{$statics_path}js/plupload.min.js"></script>
<script type="text/javascript" src="{$statics_path}js/jquery.plupload.queue.min.js"></script>
<script>
$(function() {
    plupload.addI18n({
        'Filename' : '文件名',
        'Status' : '状态',
        'Size' : '大小',
        'Add files' : '添加图片',
        'Stop current upload' : '停止上传',
        'Start uploading queue' : '开始上传',
        'Start upload' : '开始上传',
        'Uploaded %d/%d files':'已上传 %d/%d 图片',
        'Drag files here.' : '拖拽文件至此处.'
    });

   $("#muilti_uploader").pluploadQueue({
        runtimes : 'html5,flash',
        url : '{link ctl=upload act=process t=save_tmp}',
        max_file_size : '10mb',
        chunk_size : '512kb',
        unique_names : true,
        multipart: false,
        filters : [
            {title : "Image files", extensions : "jpg,jpeg,gif,png,bmp"}
        ],
        flash_swf_url : '{$statics_path}swf/plupload.flash.swf',
        resize : {width : 1000, height : 1000, quality : 100}
    });
    var uploader = $('#muilti_uploader').pluploadQueue();
    var usubmited = 0;
    uploader.bind('UploadProgress', function() {
        if (uploader.total.uploaded == uploader.files.length && usubmited == 0){
            usubmited = 1;
            Mui.box.setData('<div class="loading">Loading...</div>');
            Mui.form.sendPop('upload_photos_form');
            setTimeout(function(){
                $('#upload_photos_form').submit();
            },200);
        }
    });
    $('#upload_photos_form').find('input[name="uploadbtn"]').click(function(e) {
        if (uploader.total.uploaded == 0) {
            if (uploader.files.length > 0) {
                uploader.start();
            } else {
                Mui.box.alert('提示','至少选择一个文件上传.','确定');
            }
        }
    });
});

function reload_albums_options(je){
    $.get('{link ctl=albums act=ajaxlist t=all}',{},function(data){
        setTimeout(function(){
            Mui.box.close();
        },1000);
        if(data.ret){
            $(je).empty();
            for(v in data.list){
                $(je).addOption(data.list[v],v);
            }
        }
    },'json');
}
</script>
                        <div id="upload_field">
                            <form id="upload_photos_form" method="post" action="{link ctl=upload act=save t=multi}" onsubmit="return false;">
                                <div class="field">
                                    <div class="label">选择相册:</div>
                                    <div class="ipts">
                                        <select id="album_id" name="album_id">
                                            <!--{loop $albums_list $k $v}-->
                                                <option value="{$k}" {if $album_id==$k}selected="selected"{/if}>{$v}</option>
                                            <!--{/loop}-->
                                        </select> <a  href="javascript:void(0)" onclick="Mui.box.show('{link ctl=albums act=create}');Mui.box.callback = function(){ reload_albums_options('#album_id'); }" class="ml10">新建相册</a></div>
                                    <div class="clear"></div>
                                </div>
                                <div id="muilti_uploader">
                                    <div class="notice_info">
                                    载入中... <a href="{link ctl=upload act=normal}">如果长时间没有响应，可以点此处切换至普通上传方式！</a>
                                    </div>
                                </div>
                                <div align="center"><input type="button" name="uploadbtn" class="ylbtn" value="立即上传" /></div>
                            </form>
                        </div>
                        <!--{else}-->
                        <div class="no_data_info">
                            <div class="pic no_album"></div>
                            <div class="data_msg">
                                <div>{lang no_album_notice}</div >
                                <div class="button"><div class="bigbutton"><a href="javascript:void(0)" onclick="Mui.box.show('{link ctl=albums act=create}');"><span>{lang create_new_album}</span></a></div></div>
                            </div>
                            <div class="clear"></div>
                        </div>
                        <!--{/if}-->
                    </div>
                </div>
            </td>
        </tr>
    </table>
</div>

{template block/footer}