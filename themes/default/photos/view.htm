{template block/header}
<style type="text/css">
  span.pre_cur{
      cursor: url("{$style_path}images/pre.cur"), auto;
  }
  span.next_cur{
      cursor: url("{$style_path}images/next.cur"), auto;
  }
</style>
<div id="bodywrap">
    <table class="layout">
        <tr>
            <td class="left">
                <div class="mainbody">
                    <!--<div class="col titbg">
                        <h1 class="f_left">{lang view_photo}</h1>
                        <h4 class="f_left">{lang photo_nav_title|$current_photo|`$album_info['photos_num']`}</h4>
                        {$photo_col_ctl}
                    </div>-->
                    <div class="innercol grid">
                        <div id="pic_block" class="tbmu">
                            <span class="f_left">{lang photo_nav_title|$current_photo|`$album_info['photos_num']`}</span>
                            <div class="f_right">
                                {$view_nav}
                            </div>
                        </div>
                        
                        <div id="photo_body">
                            {$photo_body_append}
                            <span id="imgarea">
                                <img class="photo" alt="{$info['name']}" src="{img $info['path']}" />
                            </span>
                            <!--<div class="ctl"><div class="prev"><span>{lang prev_photo}</span></div><div class="next"><span>{lang next_photo}</span></div></div>-->
                        </div>
                        <div id="photo_infos">
                            
                            <div class="photo_main">
                                <h1>
                                    <!--{if $loggedin}-->
                                    <div class="inline_edit" title="{lang click_editable}" onclick="Madmin.inline_edit(this,'{link ctl=photos act=modify_name_inline id=$info['id']}')">{$info['name']} <span class="i_editinfo sprite"></span>
                                    </div>
                                    <!--{else}-->
                                    <div class="inline">
                                        {$info['name']}
                                    </div>
                                    <!--{/if}-->
                                </h1>
                                <div class="desc">
                                    <!--{if $loggedin}-->
                                    <div class="inline_edit" title="{lang click_editable}" onclick="Madmin.inline_edit(this,'{link ctl=photos act=modify_desc_inline id=$info['id']}')"><!--{if !$info['desc']}-->
                                        {lang no_photo_desc}
                                        <!--{else}-->
                                        {$info['desc']}
                                        <!--{/if}--> <span class="i_editinfo sprite"></span>
                                    </div>
                                    <!--{else}-->
                                    <div class="inline">
                                        {$info['desc']}
                                    </div>
                                    <!--{/if}-->
                                </div>
                                <div class="tags">
                                    <!--{if $loggedin}-->
                                    <div class="inline_edit" title="{lang click_editable}" onclick="Madmin.inline_edit(this,'{link ctl=photos act=modify_tags_inline id=$info['id']}')"> {lang tags}: <!--{if !$info['tags']}-->{lang no_photo_tags}<!--{else}-->{$info['tags']}<!--{/if}--> <span class="i_editinfo sprite"></span>
                                    </div>
                                    <!--{else}-->
                                    <div class="inline">
                                        <!--{if $info['tags']}-->
                                            {lang tags}: <!--{loop $info['tags_list'] $v}-->
                                            <a href="{link ctl=photos act=search tag=$v}">{$v}</a>
                                            <!--{/loop}-->
                                        <!--{/if}-->
                                    </div>
                                    <!--{/if}-->
                                </div>
                            </div>
                            <div class="clear"></div>
                        </div>
<script>
   function detect_resize_img(){
      var x = 750; //填入目标图片最大宽度
      var y = 750; //填入目标图片最大高度

      var w=parseInt('{$info['width']}'), h=parseInt('{$info['height']}');
      if(isNaN(w) || w == 0 || isNaN(h) || h == 0){
          return ; //如果丢失图片尺寸的话，直接返回
      }
      var w_original=w, h_original=h;
      if (w > x) {
        h = h * (x / w);
        w = x;
      }
      if (h > y) {
          w = w_original * (y / h_original);
          h = y;
      }
      $('#photo_body img.photo').attr({width:w,height:h});
   }

    detect_resize_img();
    var imgareaObj = $('#imgarea');
        
    imgareaObj.mousemove(function(e){
        var ps = imgareaObj.offset();
        var ps_width = imgareaObj.width();
        var nxt = e.clientX > (ps.left+ps_width/2);
        var curClass = nxt ? 'next_cur' : 'pre_cur';
        imgareaObj.attr('class',curClass);
        $('#imgarea img').attr('title',(nxt ? '{lang next_photo}' : '{lang prev_photo}'));
    });
    
    imgareaObj.click(function(e){
        var ps = imgareaObj.offset();
        var ps_width = imgareaObj.width();
        var nxt = e.clientX > (ps.left+ps_width/2);
        if(nxt){
          if($('#pic_block a.btnnext').length > 0)
            window.location.href = $('#pic_block a.btnnext').attr('href');
        }else{
          if($('#pic_block a.btnprev').length > 0)
            window.location.href = $('#pic_block a.btnprev').attr('href');
        }
    });

   $('#photo_body img').load(function(){
       $('#photo_body').css('background','none');
   });

   $(document).bind('keydown',
       function(e){
           if (e.altKey) return true;
           var target = e.target;
           if (target && target.type) return true;
           switch(e.keyCode) {
               case 63235: case 39: 
               if ($("#pic_block").find("a.btnnext").length > 0){
                    window.location=$('#pic_block a.btnnext').attr('href');
                    return false; 
               } break;
               case 63234: case 37:
               if ($("#pic_block").find("a.btnprev").length > 0){
                   window.location=$('#pic_block a.btnprev').attr('href');
                   return false; 
               } break;
           }
       }
   );

   function show_exif(o){
    var pos = $(o).offset();
    $('#meta_detail').css({'left':pos.left,'top':pos.top+$(o).height()});
    $('#meta_detail').show();
    $(document).bind("mousedown",function(e){
      var popup = $('#meta_detail').get(0);
      var e = e || window.event;
      var target = e.target || e.srcElement;
      while (target != document && target != popup) {
      target = target.parentNode;
      }
      if (target == document) {
      close_exif();
      }
    });
  }
  function close_exif(){
    $('#meta_detail').hide();
    $(document).unbind("mousedown");
  } 
</script>
                    {if $enable_comment}
                        <div class="col titbg">
                            <h1 class="f_left">{lang all_photo_comments}</h1>
                            <h4 class="f_left">{lang comments_num|`$info['comments_num']`}</h4>
                        </div>
                        <div class="innetcol">
                            <div class="comment_form">
                                <form id="photo_comment_form" action="{link ctl=comments act=post}" method="post" onsubmit="return false;">
                                    <input type="hidden" name="ref_id" value="{$ref_id}" />
                                    <input type="hidden" name="type" value="{$comments_type}" />
                                    {if $loggedin}
                                    <div class="field">
                                        {lang loginwith|<span class="title_c">`$u_info['user_nicename']`</span>}<a href="{link ctl=users act=logout}"  onclick="Mui.box.show(this.href);return false;">{lang logout}</a> ?
                                        <input type="hidden" name="email" value="{if isset($u_extrainfo['email'])}{$u_extrainfo['email']}{/if}" />
                                        <input type="hidden" name="author" value="{$u_info['user_nicename']}" />
                                    </div>
                                    {else}
                                    <div class="field">
                                        <div class="label">{lang email}</div>
                                        <div class="ipts"><input type="text" class="inputstyle iptw2" name="email" /></div>
                                        <div class="clear"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">{lang comment_user} *</div>
                                        <div class="ipts"><input type="text" class="inputstyle iptw2" name="author" /></div>
                                        <div class="clear"></div>
                                    </div>
                                    {/if}
                                    <div class="field">
                                        <div class="label">{lang comment_content} *</div>
                                        <div class="ipts"><textarea class="inputstyle ipttextarea" name="content"></textarea></div>
                                        <div class="clear"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label"> &nbsp;</div>
                                        <div class="ipts"><input type="submit" name="submit" class="ylbtn f_left" value="{lang post_comments}" onclick="Mui.box.callback=function(){ reload_comments('{link ctl=comments act=more ref_id=$ref_id type=$comments_type}');$('#photo_comment_form').get(0).reset(); };Mui.form.sendAuto('photo_comment_form');" /></div>
                                        <div class="clear"></div>
                                    </div>
                                </form>
                            </div>
                            <a name="comments"></a>
                            <div class="comment_list">
                                {template comments/more}
                            </div>
                            <div class="clear"></div>
                        </div>
                    {/if}
                    
                    </div>
                </div>
            </td>
            <td class="right">
                <div class="sidebar">
                    <div class="pic_nav">
                        <h2 class="titbg">{$album_info['name']} </h2>
                        <div class="pic_nav_body">
                        <ul>
                          <li>
                          <!--{if $picture['previous']}-->
                          <a href="{link ctl=photos act=view id=$picture['previous']['id']}#pic_block">
                            <span class="thumbnail_mask">
                              <span class="thumbnail_container">
                                <img src="{img $picture['previous']['thumb']}" style="{php echo detect_thumb($picture['previous']['width'],$picture['previous']['height'],58)}" />
                              </span>
                            </span>
                            </a>
                          <!--{else}-->
                          <a href="javascript:void(0)" class="non">
                          <span class="thumbnail_mask">
                              <span class="thumbnail_container">
                                {lang this_first_photo}
                              </span>
                            </span>
                          </a>
                          <!--{/if}-->
                          </li>
                          <li><a class="current" href="#">
                            <span class="thumbnail_mask">
                              <span class="thumbnail_container">
                                <img src="{img $info['thumb']}" style="{php echo detect_thumb($info['width'],$info['height'],58)}" />
                              </span>
                            </span>
                            </a>
                          </li>
                          <li>
                          <!--{if $picture['next']}-->
                            <a href="{link ctl=photos act=view id=$picture['next']['id']}#pic_block">
                            <span class="thumbnail_mask">
                              <span class="thumbnail_container">
                                <img src="{img $picture['next']['thumb']}" style="{php echo detect_thumb($picture['next']['width'],$picture['next']['height'],58)}" />
                              </span>
                            </span>
                            </a>
                          <!--{else}-->
                            <a href="javascript:void(0)" class="non">
                            <span class="thumbnail_mask">
                                <span class="thumbnail_container">
                                  {lang this_last_photo}
                                </span>
                              </span>
                            </a>
                          <!--{/if}-->
                          </li>
                        </ul>
                        <div class="nav_ctl">
                          <span class="nav_ctl_prev"><a href="javascript:void(0)">{lang prev_photo}</a></span>
                          <span class="slideshow"><span class="i_slideshow sprite"></span> <a href="{link ctl=photos act=slide aid=$info['album_id']}">{lang slideshow_view}</a></span>
                          <span class="nav_ctl_next"><a href="javascript:void(0)">{lang next_photo}</a></span>
                          <div class="clear"></div>
                        </div>
                        </div>
                    </div>
                    <!-- todo -->
                    <div class="mb10 mt15 tinfo">
                        <p>{lang in_upload_time}: {echo date('Y-m-d',$info['create_time'])}</p>
                        <!--{if $info['taken_time']}-->
                        <p>{lang in_taken_time}: {echo date('Y-m-d',$info['taken_time'])}</p>
                        <!--{/if}-->
                        <p>{lang image_size}: {$info['width']}×{$info['height']} <a href="{img $info['path']}" target="_blank">{lang view_orgi_photo}</a></p>
                        <p>{lang viewed_nums|`$info['hits']`}</p>
                        <!--{if $info['exif'] && isset($metas)}-->
                        <p><a href="javascript:void(0)" onclick="show_exif(this)">{lang view_exif}</a></p>
                        <div id="meta_detail" style="display:none;"> 
                          <table>
                          <!--{loop $metas $m}-->
                          <tr><td>{$m['cname']}</td><td>{$m['value']}</td></tr>
                          <!--{/loop}-->
                          </table>
                          <p class="t_right"><a href="{link ctl=photos act=meta id=$info['id']}">{lang more_exif}</a></p>
                        </div>
                        <!--{/if}-->
                    </div>
                    {$photo_view_sidebar}
                </div>
            </td>
        </tr>
    </table>
</div>
{template block/footer}