{template block/header}
<div id="bodywrap">
    <table class="layout">
        <tr>
            <td class="left">
                <div class="mainbody">
                    <div class="col titbg">
                        <h1 class="f_left">查看照片</h1>
                        <h4 class="f_left">当前第{$current_photo}张，共{$album_info['photos_num']}张</h4>
                        {$photo_col_ctl}
                    </div>
                    <div class="innercol grid">
                        <div id="pic_block" class="tbmu">
                            <span class="f_left"><a href="{link ctl=photos act=index aid=$info['album_id']}">返回照片列表</a></span>
                            <div class="f_right">
                                {if $picture['first']}<a href="{link ctl=photos act=view id=$picture['first']['id']}#pic_block">第一张</a>{else}第一张{/if}
                                <span class="pipe">|</span>
                                {if $picture['previous']}<a href="{link ctl=photos act=view id=$picture['previous']['id']}#pic_block" class="btnprev">上一张</a>{else}上一张{/if}
                                <span class="pipe">|</span>
                                {if $picture['next']}<a href="{link ctl=photos act=view id=$picture['next']['id']}#pic_block" class="btnnext">下一张</a>{else}下一张{/if}
                                <span class="pipe">|</span>
                                {if $picture['last']}<a href="{link ctl=photos act=view id=$picture['last']['id']}#pic_block">最后张</a>{else}最后张{/if}
                                <span class="pipe">|</span>
                                <span class="i_slideshow sprite"></span> <a href="{link ctl=photos act=slide aid=$info['album_id']}">幻灯浏览</a>
                            </div>
                        </div>
                        
                        <div id="photo_body">
                            <img class="photo" alt="{$info['name']}" src="{img $info['thumb']}" />
                            <div class="ctl"><div class="prev"><span>上一张</span></div><div class="next"><span>下一张</span></div></div>
                        </div>
                        <div id="photo_infos">
                            <div class="photo_others">
                                <p>上传于: {echo date('Y-m-d',$info['create_time'])}</p>
                                <!--{if $info['taken_time']}-->
                                <p>拍摄于: {echo date('Y-m-d',$info['taken_time'])}</p>
                                <!--{/if}-->
                                <p>图片尺寸: {$info['width']}×{$info['height']}</p>
                                <!--{if $info['exif']}--><p><!--{if isset($info['exif']['Model'])}-->由{$info['exif']['Model']}拍摄 <!--{/if}--><a href="{link ctl=photos act=meta id=$info['id']}">更多Exif</a></p><!--{/if}-->
                                <p>被查看了{$info['hits']}次</p>
                                <p><a href="{img $info['path']}" target="_blank">查看原图</a></p>
                            </div>
                            <div class="photo_main">
                                <h1>
                                    <!--{if $loggedin}-->
                                    <div class="inline_edit" title="点击可编辑" onclick="Madmin.inline_edit(this,'{link ctl=photos act=modify_name_inline id=$info['id']}')">{$info['name']} <span class="i_editinfo sprite"></span>
                                    </div>
                                    <!--{else}-->
                                    <div class="inline">
                                        {$info['name']}
                                    </div>
                                    <!--{/if}-->
                                </h1>
                                <div class="desc">
                                    <!--{if $loggedin}-->
                                    <div class="inline_edit" title="点击可编辑" onclick="Madmin.inline_edit(this,'{link ctl=photos act=modify_desc_inline id=$info['id']}')"><!--{if !$info['desc']}-->
                                        还没有描述，为照片添加描述吧！
                                        <!--{else}-->
                                        {$info['desc']}
                                        <!--{/if}--> <span class="i_editinfo sprite"></span>
                                    </div>
                                    <!--{else}-->
                                    <div class="inline">
                                        {$info['desc']}
                                    </div>
                                    <!--{/if}-->
                                </div>
                                <div class="tags">
                                    <!--{if $loggedin}-->
                                    <div class="inline_edit" title="点击可编辑" onclick="Madmin.inline_edit(this,'{link ctl=photos act=modify_tags_inline id=$info['id']}')"> 标签: <!--{if !$info['tags']}-->点击添加标签吧！<!--{else}-->{$info['tags']}<!--{/if}--> <span class="i_editinfo sprite"></span>
                                    </div>
                                    <!--{else}-->
                                    <div class="inline">
                                        <!--{if $info['tags']}-->
                                            标签: <!--{loop $info['tags_list'] $v}-->
                                            <a href="{link ctl=photos act=search tag=$v}">{$v}</a>
                                            <!--{/loop}-->
                                        <!--{/if}-->
                                    </div>
                                    <!--{/if}-->
                                </div>
                            </div>
                            <div class="clear"></div>
                        </div>
<script>
   function detect_resize_img(){
       var max_width = $('body').width()-350;
       var img_width = parseInt('{$info['width']}');
       if(isNaN(img_width)){
           img_width = 600;
       }
       if(img_width > max_width){
           img_width = max_width;
       }
       $('#photo_body img.photo').attr('width',img_width);
   }
   function show_pic_ctl(){
       var photo_obj = $('#photo_body img.photo');
       var pos = photo_obj.offset();
       var i_height = photo_obj.outerHeight();
       var i_width = photo_obj.outerWidth();
       var w = i_width/2;
       var ctl_obj = $('#photo_body div.ctl');
       ctl_obj.css({ left:pos.left,top:pos.top, width:i_width, height:i_height });
       {if $picture['previous']}
       ctl_obj.find('div.prev').css({ height:i_height,width:w }).show().hover(function(){
           $(this).find('span').css('display','block');
       },function(){
           $(this).find('span').css('display','none');
       }).click(function(){
           window.location.href = $('#pic_block a.btnprev').attr('href');
       });
       {/if}
       {if $picture['next']}
       ctl_obj.find('div.next').css({ height:i_height,width:w }).show().hover(function(){
          $(this).find('span').css('display','block');
       },function(){
          $(this).find('span').css('display','none');
       }).click(function(){
           window.location.href = $('#pic_block a.btnnext').attr('href');
       });
       {/if}
   }
   
   detect_resize_img();
   var img = new Image();
   img.onload = function(){
       $('#photo_body img.photo').attr('src',img.src);
   };
   img.src = "{img $info['path']}";
   
   $(function(){
       show_pic_ctl();
   });
   $(window).resize(function() {
       detect_resize_img();
       show_pic_ctl();
   });
   
   $(document).bind('keydown',
       function(e){
           if (e.altKey) return true;
           var target = e.target;
           if (target && target.type) return true;
           switch(e.keyCode) {
               case 63235: case 39: 
               if ($("#pic_block").find("a.btnnext").length > 0){
                    window.location=$('#pic_block a.btnnext').attr('href');
                    return false; 
               } break;
               case 63234: case 37:
               if ($("#pic_block").find("a.btnprev").length > 0){
                   window.location=$('#pic_block a.btnprev').attr('href');
                   return false; 
               } break;
           }
       }
   );
</script>
                    {if $enable_comment}
                        <div class="col titbg">
                            <h1 class="f_left">{lang all_photo_comments}</h1>
                            <h4 class="f_left">{lang comments_num|`$info['comments_num']`}</h4>
                        </div>
                        <div class="innetcol">
                            <div class="comment_form">
                                <form id="photo_comment_form" action="{link ctl=comments act=post}" method="post" onsubmit="return false;">
                                    <input type="hidden" name="ref_id" value="{$ref_id}" />
                                    <input type="hidden" name="type" value="{$comments_type}" />
                                    <div class="field">
                                        <div class="label">{lang email}</div>
                                        <div class="ipts"><input type="text" class="inputstyle iptw2" name="email" /></div>
                                        <div class="clear"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">{lang comment_user} *</div>
                                        <div class="ipts"><input type="text" class="inputstyle iptw2" name="author" /></div>
                                        <div class="clear"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label">{lang comment_content} *</div>
                                        <div class="ipts"><textarea class="inputstyle ipttextarea" name="content"></textarea></div>
                                        <div class="clear"></div>
                                    </div>
                                    <div class="field">
                                        <div class="label"> &nbsp;</div>
                                        <div class="ipts"><input type="submit" name="submit" class="ylbtn f_left" value="发表评论" onclick="Mui.box.callback=function(){ reload_comments('{link ctl=comments act=more ref_id=$ref_id type=$comments_type}');$('#photo_comment_form').get(0).reset(); };Mui.form.sendAuto('photo_comment_form');" /></div>
                                        <div class="clear"></div>
                                    </div>
                                </form>
                            </div>
                            <a name="comments"></a>
                            <div class="comment_list">
                                {template comments/more}
                            </div>
                            <div class="clear"></div>
                        </div>
                    {/if}
                    
                    </div>
                </div>
            </td>
            <td class="right">
                <div class="sidebar">
                    <div class="pic_nav">
                        <div class="title"><a href="{link ctl=photos act=index aid=$info['album_id']}">{$album_info['name']}</a> [共{$album_info['photos_num']}张]</div>
                        <div class="body">
                            <div>
                                <a href="javascript:void(0)" onclick="nav_turn(this,'up')" class="turn_page_up">上一张</a>
                            </div>
                            <div class="navlist">
                            <ul>
                                {if $picture['previous']}
                                <li id="pic_{echo $current_rank-1}" class="navitem"><a href="{link ctl=photos act=view id=$picture['previous']['id']}#pic_block" style="background:url('{img $picture['previous']['thumb']}') center no-repeat;"></a></li>
                                {else}
                                <li id="pic_first" class="navitem"><a href="javascript:void(0);">这是首张</a></li>
                                {/if}
                                <li id="pic_{$current_rank}" class="current navitem"><a href="{link ctl=photos act=view id=$info['id']}#pic_block" style="background:url('{img $info['thumb']}') center no-repeat;"></a></li>
                                {if $picture['next']}
                                <li id="pic_{echo $current_rank+1}" class="navitem"><a href="{link ctl=photos act=view id=$picture['next']['id']}#pic_block" style="background:url('{img $picture['next']['thumb']}') center no-repeat;"></a></li>
                                {else}
                                <li id="pic_last" class="navitem"><a href="javascript:void(0);">这是末张</a></li>
                                {/if}
                            </ul>
                            </div>
                            <div>
                                <a href="javascript:void(0)" onclick="nav_turn(this,'down')" class="turn_page_down">下一张</a>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
</div>
<script>

    function nav_move(moveto){
        var sctop =  $('.pic_nav div.body .navlist').scrollTop();
        $('.pic_nav div.body .navlist').animate({ scrollTop : sctop+moveto }, 'fast');
    }
    var nav_loading = 0;
    function nav_turn(obj,action){
        var action_url = '{link ctl=photos act=nav aid=$info['album_id']}';
        if(action=='up'){
            if($('#pic_first').length == 0){
                var top_id = $('.pic_nav div.body ul li:first').attr('id');
                var top_id = top_id.split('_')[1];
                if(nav_loading == 1){
                    return false;
                }
                nav_loading = 1;
                $.post(action_url,{direction:'up',rank_id:top_id},function(data){
                    $('.pic_nav div.body ul').prepend(data);
                    nav_move(-426);
                    nav_loading = 0;
                });
            }else{
                nav_move(-426);
            }
            
        }else{
            if($('#pic_last').length == 0){
                var last_id = $('.pic_nav div.body ul li:last').attr('id');
                var last_id = last_id.split('_')[1];
                if(nav_loading == 1){
                    return false;
                }
                nav_loading = 1;
                $.post(action_url,{direction:'down',rank_id:last_id},function(data){
                    $('.pic_nav div.body ul').append(data);
                    nav_move(426);
                    nav_loading = 0;
                });
            }else{
                nav_move(426);
            }
        }
    }
</script>
{template block/footer}